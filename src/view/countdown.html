{% extends "document.html" %}

{% block body %}
<div class="col-md-12">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">Back</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav>
  <div id="vApp" v-cloak class="app-countdown" data-theme="blue">
    <div class="timer">
      <div class="progress-circle">
        <svg viewBox="0 0 36 36">
          <path class="bg" d="M18 2.0845
            a 15.9155 15.9155 0 0 1 0 31.831
            a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path :style="`transition-duration: ${speed}; stroke-dasharray: ${percentage} 100;`" class="progress" d="M18 2.0845
            a 15.9155 15.9155 0 0 1 0 31.831
            a 15.9155 15.9155 0 0 1 0 -31.831" />
        </svg>
      </div>
      <div class="text">
        <div @click="onEditTime" v-if="!isEditableTime">${timeOutput}</div>
        <div v-if="isEditableTime">
          <input v-model="timeInput" ref="timeInput" id="timeInput" @blur="onTimeInputBlur" placeholder="00:00:00"
            type="text" class="form-control text-center">
        </div>
      </div>
    </div>

    <button @click="onToggle" class="btn btn-primary w-100">
      <template v-if="timerStatus===0">Play</template>
      <template v-if="timerStatus===1">Pause</template>
      <template v-if="timerStatus===2">Resume</template>
      <template v-if="timerStatus===3">Reset</template>
    </button>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{super()}}
<script>
  let timerId = null
  let startTime = 0
  let endTime = 0
  let secondsRemaining = 0
  let vApp = new Vue({
    el: '#vApp',
    delimiters: ["${", "}"],
    mixins: [
    ],
    data: {
      pending: false,
      isEditableTime: false,
      timeInput: '00:00:10',
      timeOutput: '',
      endTime: 0,
      percentage: 0,
      speed: '0s',
      timerStatus: 0, // 0 - ready, 1 - running, 2 - paused, 3 - ended
    },
    watch: {
      isEditableTime: function (cur, prev) {
        const me = this
        if (me.isEditableTime) {
          me.$nextTick(() => {
            me.$refs.timeInput.focus();
          })
        }
      },

    },
    mounted: function () {
      const me = this

      me.onTimeInputBlur()
    },

    methods: {
      onEditTime: function () {
        const me = this
        if(me.timerStatus===0){
          me.isEditableTime = true
        }
      },

      onTimeInputBlur: function () {
        const me = this

        const time = me.getTimeComponents(me.timeInput)
        me.timeInput = me.timeToDisplay(time)
        me.timeOutput = me.timeInput
        me.isEditableTime = false

      },

      timeToDisplay: function (time) {
        const me = this

        return `${String(time?.hours).padStart(2, '0')}:${String(time?.minutes).padStart(2, '0')}:${String(time?.seconds).padStart(2, '0')}`
      },

      getTimeComponents: function (timeInput) {
        const me = this

        timeInput = String(timeInput).replace(/[^0-9:]/g, '');
        timeInput = String(timeInput).replace(/(:)+/ig, ':').replace(/^:+|:+$/g, '');
        if (!timeInput) timeInput = '0'

        let components = timeInput.split(':')
        let hours = 0, minutes = 0, seconds = 0
        if (components.length >= 3) {
          hours = Math.min(23, parseInt(components.at(0)))
          minutes = Math.min(59, parseInt(components.at(1)))
          seconds = Math.min(59, parseInt(components.at(2)))
        } else if (components.length >= 2) {
          minutes = Math.min(59, parseInt(components.at(0)))
          seconds = Math.min(59, parseInt(components.at(1)))
        } else if (components.length >= 1) {
          seconds = Math.min(59, parseInt(components.at(0)))
        }

        return {
          hours, minutes, seconds
        }
      },

      startTimer: function () {
        const me = this
        // me.speed = '0s';
        // me.percentage = 0;
        const { hours, minutes, seconds } = me.getTimeComponents(me.timeInput)
        startTime = moment()
        endTime = startTime.clone().add(hours, 'hours').add(minutes, 'minutes').add(seconds, 'seconds')

        secondsRemaining = Math.floor(moment.duration(endTime.diff(startTime)).asSeconds())
        // console.log('secondsRemaining', secondsRemaining)
        // me.speed = `${moment.duration(endTime.diff(startTime)).asSeconds() - 1}s`
        // me.percentage = 100;
        timerId = setInterval(me.onTick, 1000)

      },

      onTick: function () {
        const me = this

        if (me.timerStatus === 1) {
          secondsRemaining -= 1
          // console.log(secondsRemaining)

          let remaining = moment.duration(secondsRemaining, 'seconds')
          let rHours = Math.floor(remaining.hours())
          let rMinutes = Math.floor(remaining.minutes())
          let rSeconds = Math.floor(remaining.seconds())
          me.timeOutput = me.timeToDisplay({
            hours: rHours,
            minutes: rMinutes,
            seconds: rSeconds,
          })

          if (secondsRemaining <= 0) {
            clearInterval(timerId)
            me.timerStatus = 3 // ended
          }

        }
      },

      

      onToggle: function () {
        const me = this;
        if (me.timerStatus === 0) {
          me.timerStatus = 1
          me.startTimer()

        } else if (me.timerStatus === 1) {
          me.timerStatus = 2 // pause

        } else if (me.timerStatus === 2) {
          me.timerStatus = 1 // running

        } else if (me.timerStatus === 3) { // ended
          me.timerStatus = 0 // ready
          me.timeOutput = me.timeInput

        }
      }
    }
  })
</script>
{% endblock %}